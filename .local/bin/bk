#!/bin/bash
#
# This script provides a modular and automated backup solution using rsync.
# It reads backup task definitions from individual files in the '~/.backup_tasks' directory.
#
# --- How to Use ---
# 1. Define Backup Tasks:
#    For each directory you want to backup, create a file in the '~/.backup_tasks' directory.
#    The filename will be used as the destination sub-directory name in your external drive.
#    Inside each file, simply put the *full path* to the source directory you want to backup.
#    Example: To backup '/home/gramms/Documents' to '~/Extern/Backup/MyDocs':
#             echo "/home/gramms/Documents" > ~/.backup_tasks/MyDocs
#
# 2. Run the Script:
#    Ensure your external drive (defined by DEST_BASE_DIR) is mounted.
#    Execute the script from your terminal: ~/.local/bin/bk
#
#    This script can also be automated using a systemd timer for daily execution.
#

# A modular and robust backup script using rsync.

DEST_BASE_DIR="/home/gramms/Extern/Backup"
TASKS_DIR="/home/gramms/.backup_tasks"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Rsync Check
if ! command -v rsync &> /dev/null
then
    echo -e "${RED}Error: rsync is not installed.${NC}"
    echo -e "${YELLOW}Please install rsync. On Arch Linux, you can run: sudo pacman -S rsync${NC}"
    exit 1
fi


for task_file in "$TASKS_DIR"/*; do
    task_name=$(basename "$task_file")
    source_dir=$(cat "$task_file")
    dest_dir="$DEST_BASE_DIR/$task_name"
    
    echo -e "-------------------------------------"
    echo -e "${CYAN}Processing task: $task_name${NC}"
    
    if [ -z "$source_dir" ]; then
        echo -e "${YELLOW}Warning: Task file '$task_name' is empty. Skipping.${NC}"
        ((fail_count++))
        continue
    fi
    
    if [ ! -d "$source_dir" ]; then
        echo -e "${RED}Error: Source directory '$source_dir' for task '$task_name' does not exist. Skipping.${NC}"
        ((fail_count++))
        continue
    fi
    
    echo "  Source: $source_dir"
    echo "  Destination: $dest_dir"
    
    rsync -ah --delete --progress "$source_dir/" "$dest_dir"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Task '$task_name' completed successfully.${NC}"
        ((success_count++))
    else
        echo -e "${RED}Error: Task '$task_name' failed during rsync operation.${NC}"
        ((fail_count++))
    fi
done

echo -e "-------------------------------------"
echo -e "${CYAN}Backup process finished.${NC}"
echo -e "${GREEN}Successful tasks: $success_count${NC}"
echo -e "${RED}Failed tasks: $fail_count${NC}"

if (( fail_count > 0 )); then
    exit 1
else
    exit 0
fi
